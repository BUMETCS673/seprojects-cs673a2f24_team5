name: CI for E2E

on:
  push:

jobs:
  e2e-test:
    runs-on: ubuntu-latest

    services:
      # 前端服务 (Node.js)
      frontend:
        image: node:18
        options: --network-alias frontend
        env:
          PORT: 3000
        ports:
          - 3000:3000

      # 后端服务 (Python)
      backend:
        image: python:3.10
        options: --network-alias backend
        env:
          PORT: 5000
        ports:
          - 5000:5000


    steps:
      # Step 1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: 前端设置和启动
      - name: Set up and start frontend
        working-directory: ./fe_repo  # 前端代码目录
        run: |
          npm install -g pnpm
          pnpm i
          pnpm lint
          pnpm build

      # Step 3: 后端设置和启动
      - name: Set up and start backend
        working-directory: ./be_repo  # 后端代码目录
        run: |
          pip install -r requirements.txt
          python app.py &

      # Step 4: 等待前后端服务启动
      - name: Wait for services to be ready
        run: |
          # 等待前端服务
          until curl -s http://localhost:3000; do
            echo "Waiting for frontend to be ready..."
            sleep 5
          done

          # 等待后端服务
          until curl -s http://localhost:5000; do
            echo "Waiting for backend to be ready..."
            sleep 5
          done

      # Step 5: 运行E2E测试
      - name: Run E2E tests
        run: |
          python test_e2e.py